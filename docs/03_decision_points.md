# Decision Points

本文件定義決策點管道（D0–D6）的詳細規格，包含流程、閘道機制、狀態轉換與失敗處理。

## 決策點概覽

本 PoC 定義七個決策點，形成從信號接收到狀態回滾的完整流程：

- **D0 Pre-Alert** — 確認並監控候選事件
- **D1 Dispatch recommendation** — 建議資源配置等級
- **D2 Local guidance activation** — 啟用低影響指引
- **D3 Zone escalation (high-impact)** — 區域升級（需雙人控制 + 死手保持 + TTL）
- **D4 Multi-zone/network coordination (high-impact)** — 多區域/網路級協調（需更嚴格審批）
- **D5 Public warning broadcast (high-impact)** — 公開警告廣播（CAP + 一致性檢查）
- **D6 De-escalation & evidence sealing** — 降級與證據封存

## 決策點詳細規格

### D0 — Pre-Alert（預警確認）

**目的**：操作人員確認候選事件並啟用監控模式。

**輸入規格**：

- 聚合後的信號摘要（來源：基礎設施、人員、群眾）
- 信號來源數量（x_s 貢獻）
- 時間窗口標記
- 區域識別碼（Z1/Z2/Z3/Z4）

**處理流程**：

1. 信號接收與初步驗證（格式檢查、時間戳驗證）
2. 操作人員檢視信號摘要（儀表板呈現）
3. 操作人員確認或駁回（單人操作，低影響）
4. 確認後啟用監控模式（開始記錄決策鏈）

**輸出規格**：

- 預警狀態（active/inactive）
- 監控開始時間戳
- 初始信號摘要快照
- 操作人員識別碼（審計用）

**閘道機制**：

- **控制要求**：單人操作（低影響決策）
- **TTL**：不適用（預警狀態需手動關閉）
- **回滾**：操作人員可手動關閉預警

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 可同時監控多個區域

**失敗模式與降級**：

- **信號接收失敗**：使用最後已知狀態，標記為「資料延遲」
- **操作人員無回應**：系統提示，但不自動升級
- **監控系統故障**：降級至手動記錄模式

**假設**：

- 操作人員可及時檢視信號摘要
- 信號聚合系統正常運作

**攻擊考量**：

- 信號偽造：需信號來源驗證與跨來源佐證
- 操作人員帳號盜用：需雙因子認證與操作日誌審計

**隱私影響**：

- 僅處理聚合後信號，不涉及個別資料
- 操作日誌需去識別化處理

---

### D1 — Dispatch Recommendation（資源配置建議）

**目的**：基於佐證信號，建議適當的資源配置等級。

**輸入規格**：

- D0 預警狀態（active）
- 佐證後的信號摘要（至少 2 個獨立來源）
- 信號信心度評分
- 區域識別碼與資源可用性

**處理流程**：

1. 信號佐證檢查（至少 2 個獨立來源，時間窗口內）
2. 資源需求評估（基於信號類型與區域特性）
3. 建議等級生成（站務人員 / 保全 / 第一線應變 / 多單位協調）
4. 操作人員檢視建議（可接受、修改或駁回）

**輸出規格**：

- 建議資源等級（1-4 級，定義見下方）
- 建議資源類型（人員、設備、外部單位）
- 建議配置時間（立即 / 5 分鐘 / 15 分鐘）
- 信心度評分（0.0-1.0）
- 操作人員決策（接受/修改/駁回）

**資源等級定義**：

- **等級 1**：站務人員（日常營運支援）
- **等級 2**：保全人員（安全監控與初步應變）
- **等級 3**：第一線應變（消防、醫療、警察）
- **等級 4**：多單位協調（大型事件，需跨單位協調）

**閘道機制**：

- **控制要求**：單人操作（建議性質，非執行）
- **TTL**：不適用（建議需手動執行或過期）
- **回滾**：操作人員可修改或駁回建議

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 區域特性影響資源類型建議（例如 Z2 需列車控制中心協調）

**失敗模式與降級**：

- **佐證不足**：建議等級降級（例如從等級 3 降至等級 2）
- **資源不可用**：建議替代資源或延遲配置
- **建議系統故障**：降級至手動資源配置

**假設**：

- 資源可用性資訊可即時取得
- 操作人員具備資源配置決策權限

**攻擊考量**：

- 信號佐證偽造：需跨來源驗證與時間窗口檢查
- 資源配置濫用：需操作日誌審計與異常檢測

**隱私影響**：

- 僅處理聚合後信號，不涉及個別資料
- 資源配置記錄需去識別化處理

---

### D2 — Local Guidance Activation（本地指引啟用）

**目的**：啟用低影響的本地指引（PA、電子看板、App），不造成恐慌。

**輸入規格**：

- D1 資源配置建議（已接受）
- 指引類型需求（疏散 / 避險 / 資訊更新）
- 區域識別碼與可用通道

**處理流程**：

1. 指引內容生成（基於 CAP 模板，見 [templates/cap_message_template.md](../templates/cap_message_template.md)）
2. 通道選擇（PA / 電子看板 / App / 組合）
3. 內容審核（操作人員確認內容適當性）
4. 通道發布（同步發布至選定通道）

**輸出規格**：

- 指引狀態（active/inactive）
- 發布通道列表
- 指引內容（CAP 格式）
- 發布時間戳
- 操作人員識別碼（審計用）

**閘道機制**：

- **控制要求**：單人操作（低影響，但需內容審核）
- **TTL**：指引內容包含過期時間（預設 30 分鐘，可調整）
- **回滾**：操作人員可手動關閉指引

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 區域特性影響可用通道（例如 Z2 主要使用車廂內廣播）

**失敗模式與降級**：

- **通道故障**：切換至備用通道（例如 PA 故障時使用電子看板）
- **內容生成失敗**：使用預設模板
- **多通道不一致**：強制使用 CAP 標準格式確保一致性

**假設**：

- 指引通道正常運作
- 操作人員可及時審核內容

**攻擊考量**：

- 指引內容偽造：需數位簽章與完整性驗證
- 通道入侵：需通道間隔離與安全通訊

**隱私影響**：

- 指引內容為公開資訊，不涉及個別資料
- 指引發布記錄需審計日誌

---

### D3 — Zone Escalation（區域升級）

**目的**：將單一區域（Z1/Z2/Z3/Z4）升級至高度警戒狀態，啟用額外控制措施。

**輸入規格**：

- D2 本地指引已啟用（或直接從 D1 升級）
- 升級理由（信號摘要、佐證結果、風險評估）
- 目標區域識別碼
- 升級等級（1-3 級，定義見下方）

**處理流程**：

1. 升級提案生成（包含理由、預期措施、TTL）
2. **雙人控制檢查**：需 2 名授權操作人員同時批准
3. **死手保持啟動**：批准後需持續保持（keepalive），預設間隔 60 秒
4. 升級執行（啟用區域控制措施）
5. 持續監控（每 60 秒檢查 keepalive 狀態）

**輸出規格**：

- 升級狀態（active/inactive）
- 升級等級（1-3 級）
- 啟用措施列表（例如：出入口控制、流量限制、額外資源）
- 升級開始時間戳
- TTL（預設 30 分鐘，可調整）
- 雙人控制記錄（2 名操作人員識別碼）
- Keepalive 狀態（最後更新時間戳）

**升級等級定義**：

- **等級 1**：加強監控（額外人員、更頻繁信號檢查）
- **等級 2**：部分控制（特定出入口限制、流量引導）
- **等級 3**：全面控制（主要出入口封閉、強制疏散）

**閘道機制**：

- **控制要求**：**雙人控制**（2 名授權操作人員，需獨立認證）
- **死手保持**：批准後需每 60 秒發送 keepalive，超過 120 秒未收到則自動回滾
- **TTL**：升級狀態預設 30 分鐘，到期自動回滾（可手動延長，需重新雙人批准）
- **回滾**：
  - 自動回滾：TTL 到期、keepalive 超時
  - 手動回滾：操作人員主動降級（需單人操作，記錄審計）

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 可針對區域子區域（例如 Z1 的特定月台）
- 區域特性影響可用措施（例如 Z2 需列車控制中心協調）

**失敗模式與降級**：

- **雙人控制失敗**：升級提案自動駁回
- **Keepalive 超時**：自動回滾至 D2 或 D1 狀態
- **TTL 到期**：自動回滾，需重新提案
- **區域控制系統故障**：降級至手動控制模式

**假設**：

- 2 名授權操作人員可同時在線
- Keepalive 機制正常運作
- 區域控制系統可可靠執行措施

**攻擊考量**：

- 雙人控制繞過：需獨立認證與操作日誌審計
- Keepalive 偽造：需加密與完整性驗證
- 區域控制系統入侵：需硬體完整性驗證與網路隔離

**隱私影響**：

- 升級狀態可能影響區域內人員的移動自由
- 升級記錄需完整審計，包含理由與決策鏈

---

### D4 — Multi-Zone/Network Coordination（多區域/網路級協調）

**目的**：協調多個區域或整個網路（多站點）的狀態，啟用跨區域措施。

**輸入規格**：

- 至少 2 個區域的 D3 升級狀態（或直接提案）
- 協調理由（跨區域事件、網路級影響、資源共享需求）
- 目標區域列表
- 協調等級（1-2 級，定義見下方）

**處理流程**：

1. 協調提案生成（包含理由、目標區域、預期措施、TTL）
2. **嚴格審批檢查**：需 2 名授權操作人員 + 1 名主管批准（共 3 人）
3. **死手保持啟動**：批准後需持續保持（keepalive），預設間隔 60 秒
4. 協調執行（同步啟用多區域措施）
5. 持續監控（每 60 秒檢查 keepalive 狀態與區域狀態）

**輸出規格**：

- 協調狀態（active/inactive）
- 協調等級（1-2 級）
- 目標區域列表
- 啟用措施列表（跨區域資源調度、網路級指引、交通協調）
- 協調開始時間戳
- TTL（預設 20 分鐘，可調整）
- 審批記錄（3 名操作人員識別碼）
- Keepalive 狀態（最後更新時間戳）

**協調等級定義**：

- **等級 1**：區域間資訊共享與資源調度（不影響個別區域的 D3 狀態）
- **等級 2**：網路級統一措施（例如：多站點同步疏散指引、交通管制）

**閘道機制**：

- **控制要求**：**嚴格審批**（2 名授權操作人員 + 1 名主管，需獨立認證）
- **死手保持**：批准後需每 60 秒發送 keepalive，超過 120 秒未收到則自動回滾
- **TTL**：協調狀態預設 20 分鐘，到期自動回滾（可手動延長，需重新嚴格審批）
- **回滾**：
  - 自動回滾：TTL 到期、keepalive 超時
  - 手動回滾：操作人員主動降級（需 2 人批准，記錄審計）

**與區域的對應**：

- 適用於多個區域組合（例如：Z1+Z3、Z2+Z1、Z4+Z1+Z3）
- 可涵蓋整個網路（所有站點）

**失敗模式與降級**：

- **嚴格審批失敗**：協調提案自動駁回
- **Keepalive 超時**：自動回滾，各區域回歸個別 D3 或更低狀態
- **TTL 到期**：自動回滾，需重新提案
- **區域間通訊故障**：降級至個別區域控制模式

**假設**：

- 3 名授權人員（2 名操作人員 + 1 名主管）可同時在線
- 區域間通訊通道安全且可靠
- Keepalive 機制正常運作

**攻擊考量**：

- 嚴格審批繞過：需獨立認證與操作日誌審計
- 區域間通訊偽造：需加密與完整性驗證
- 網路級控制系統入侵：需硬體完整性驗證與網路隔離

**隱私影響**：

- 協調狀態可能影響多個區域內人員的移動自由
- 協調記錄需完整審計，包含理由與決策鏈

---

### D5 — Public Warning Broadcast（公開警告廣播）

**目的**：發布 CAP 格式的公開警告，透過 Route 1 與 Route 2 通道同步發布。

**輸入規格**：

- D3 或 D4 升級狀態（或直接從 D2 升級，需嚴格審批）
- CAP 訊息內容（基於 [templates/cap_message_template.md](../templates/cap_message_template.md)）
- 目標區域列表
- 發布通道選擇（Route 1 通道 + Route 2 App）

**處理流程**：

1. CAP 訊息生成（基於模板，填入事件資訊）
2. **一致性檢查**：確保 CAP 訊息與當前區域狀態一致
3. **雙人控制檢查**：需 2 名授權操作人員同時批准
4. **死手保持啟動**：批准後需持續保持（keepalive），預設間隔 60 秒
5. 同步發布（Route 1：cell broadcast、SMS、PA、電子看板；Route 2：App push）
6. 持續監控（每 60 秒檢查 keepalive 狀態與通道狀態）

**輸出規格**：

- 警告狀態（active/inactive）
- CAP 訊息識別碼
- 發布通道列表
- 發布時間戳
- TTL（CAP 訊息過期時間，預設 60 分鐘，可調整）
- 雙人控制記錄（2 名操作人員識別碼）
- Keepalive 狀態（最後更新時間戳）

**閘道機制**：

- **控制要求**：**雙人控制**（2 名授權操作人員，需獨立認證）
- **一致性檢查**：CAP 訊息必須與當前區域狀態一致（自動驗證）
- **死手保持**：批准後需每 60 秒發送 keepalive，超過 120 秒未收到則自動回滾
- **TTL**：CAP 訊息包含過期時間，到期自動失效（可手動更新，需重新雙人批准）
- **回滾**：
  - 自動回滾：TTL 到期、keepalive 超時
  - 手動回滾：操作人員主動取消警告（需雙人批准，發布取消訊息）

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 可針對多個區域（需 D4 協調）

**失敗模式與降級**：

- **一致性檢查失敗**：CAP 訊息生成自動駁回，需重新生成
- **雙人控制失敗**：發布提案自動駁回
- **Keepalive 超時**：自動回滾，發布取消訊息
- **通道發布失敗**：部分通道故障時，優先保證 Route 1 通道（cell broadcast、SMS）
- **多通道不一致**：強制使用 CAP 標準格式，自動同步

**假設**：

- 2 名授權操作人員可同時在線
- Route 1 與 Route 2 通道正常運作
- CAP 訊息格式符合標準

**攻擊考量**：

- CAP 訊息偽造：需數位簽章與完整性驗證
- 通道入侵：需通道間隔離與安全通訊
- 一致性檢查繞過：需自動驗證機制與操作日誌審計

**隱私影響**：

- CAP 訊息為公開資訊，不涉及個別資料
- 警告發布記錄需完整審計

---

### D6 — De-escalation & Evidence Sealing（降級與證據封存）

**目的**：將區域狀態降級，並封存事件相關證據供後續審計與改善。

**輸入規格**：

- 當前決策點狀態（D3/D4/D5 或更低）
- 降級理由（事件結束、誤報確認、資源回收）
- 事件識別碼

**處理流程**：

1. 降級提案生成（包含理由、目標狀態、證據封存範圍）
2. **單人操作**：操作人員確認降級（低影響，但需記錄理由）
3. 狀態回滾（關閉升級措施、停止指引、取消警告）
4. 證據封存（決策鏈、信號摘要、操作日誌、審計記錄）
5. 封存完成確認（不可變更標記）

**輸出規格**：

- 降級後狀態（D0/D1/D2 或 inactive）
- 證據封存識別碼
- 封存時間戳
- 操作人員識別碼（審計用）

**證據封存內容**：

- 決策鏈完整記錄（D0-D6 的所有狀態轉換）
- 信號摘要快照（聚合後資料，不包含原始個別資料）
- 操作日誌（所有操作人員動作，去識別化處理）
- 審計記錄（所有資料存取記錄）
- 區域狀態歷史（時間序列摘要）

**閘道機制**：

- **控制要求**：單人操作（低影響，但需記錄理由）
- **TTL**：不適用（降級為最終狀態）
- **回滾**：不適用（證據封存後不可變更）

**與區域的對應**：

- 適用於所有區域（Z1/Z2/Z3/Z4）
- 可針對多個區域（需 D4 協調後統一降級）

**失敗模式與降級**：

- **證據封存失敗**：重試機制，最多 3 次，失敗則標記為「封存異常」
- **狀態回滾失敗**：部分措施可能需手動關閉，記錄為「部分回滾」

**假設**：

- 證據封存系統正常運作
- 操作人員可及時確認降級

**攻擊考量**：

- 證據封存偽造：需數位簽章與完整性驗證
- 證據刪除：封存後不可變更，需備份機制

**隱私影響**：

- 證據封存僅包含聚合後資料與去識別化日誌
- 封存資料需符合資料保留期限（見 [docs/08_privacy_legal_abuse.md](08_privacy_legal_abuse.md)）

---

## 決策點間狀態轉換

### 狀態轉換規則

1. **線性流程**：D0 → D1 → D2 → D3/D4/D5 → D6
2. **跳躍流程**：D1 可直接跳至 D3/D4/D5（需嚴格審批）
3. **並行流程**：D3 與 D4 可並行（D4 需至少 2 個 D3 狀態）
4. **回滾流程**：任何決策點可回滾至較低狀態（需適當授權）

### 狀態轉換圖

```
[信號輸入] → D0 (Pre-Alert)
                ↓
            D1 (Dispatch Recommendation)
                ↓
            D2 (Local Guidance)
                ↓
        ┌───────┴───────┐
        ↓               ↓
    D3 (Zone Escalation)  D4 (Multi-Zone Coordination)
        ↓               ↓
        └───────┬───────┘
                ↓
            D5 (Public Warning)
                ↓
            D6 (De-escalation)
```

### 狀態轉換條件

- **D0 → D1**：操作人員確認，信號佐證充足
- **D1 → D2**：資源配置建議已接受
- **D2 → D3**：需雙人控制批准
- **D2/D3 → D4**：需嚴格審批（3 人），至少 2 個區域需協調
- **D2/D3/D4 → D5**：需雙人控制批准，CAP 訊息一致性檢查通過
- **任何狀態 → D6**：操作人員確認降級

---

## 決策點與區域對應表

| 決策點 | Z1 (站內)    | Z2 (列車)    | Z3 (站周邊)  | Z4 (其他高密度區) |
| ------ | ------------ | ------------ | ------------ | ----------------- |
| D0     | ✓            | ✓            | ✓            | ✓                 |
| D1     | ✓            | ✓            | ✓            | ✓                 |
| D2     | ✓            | ✓            | ✓            | ✓                 |
| D3     | ✓            | ✓            | ✓            | ✓                 |
| D4     | ✓ (需多區域) | ✓ (需多列車) | ✓ (需多區域) | ✓ (需多區域)      |
| D5     | ✓            | ✓            | ✓            | ✓                 |
| D6     | ✓            | ✓            | ✓            | ✓                 |

**註**：D4 需至少 2 個區域參與協調。

---

## 決策點複雜度貢獻（x_d）

每個決策點對決策深度（x_d）的貢獻：

- **D0**：x_d = 1（基礎決策）
- **D1**：x_d = 2（建議生成）
- **D2**：x_d = 3（指引發布）
- **D3**：x_d = 4（區域升級，需雙人控制）
- **D4**：x_d = 5（多區域協調，需嚴格審批）
- **D5**：x_d = 6（公開警告，需雙人控制 + 一致性檢查）
- **D6**：x_d = 1（降級，不增加複雜度）

**總決策深度**：x_d = max(已啟用決策點的 x_d 值)

**範例**：若同時啟用 D0、D1、D2、D3，則 x_d = 4。
