# Route 1 — Baseline (No Download)

本文件定義 Route 1（基準通道）的詳細規格，包含 CAP 訊息轉換、通道優先順序、多語言支援與故障處理。

## 設計原則

1. **無需 App 安裝**
   - 所有功能不依賴 App 安裝
   - 使用標準通訊通道（cell broadcast、SMS、PA 等）

2. **大規模一致性**
   - 所有通道發布一致的指引
   - 基於 CAP 標準格式確保一致性

3. **最低保證**
   - Route 1 是系統的最低保證
   - Route 2 不得替代 Route 1

---

## 標準警告格式（CAP）

### CAP 訊息結構

Route 1 使用 CAP（Common Alerting Protocol）作為標準警告格式。詳細模板見 [templates/cap_message_template.md](../templates/cap_message_template.md)。

**CAP 訊息核心欄位**：
- **Identifier**：唯一識別碼
- **Sender**：發送者識別碼
- **Sent**：發送時間戳（ISO8601）
- **Status**：狀態（Actual / Test / Exercise）
- **MsgType**：訊息類型（Alert / Update / Cancel）
- **Scope**：範圍（Public / Restricted）
- **Info**：資訊區塊（語言、類別、事件、緊急度、嚴重度、確定度、標題、描述、指引、聯絡資訊）
- **Area**：區域資訊（區域識別碼、區域類型、時間窗口）
- **Expires**：過期時間戳（ISO8601）

### CAP 訊息生成流程

**步驟 1：決策點觸發**
- D5（Public Warning Broadcast）觸發 CAP 訊息生成（見 [docs/03_decision_points.md](03_decision_points.md)）

**步驟 2：內容填入**
- 基於當前區域狀態填入 CAP 欄位
- 使用預定義模板確保一致性

**步驟 3：一致性檢查**
- 檢查 CAP 訊息與當前區域狀態一致
- 檢查 CAP 訊息格式符合標準

**步驟 4：數位簽章**
- 對 CAP 訊息進行數位簽章（RSA-2048 或 ECDSA-P256）
- 確保訊息完整性與來源驗證

**步驟 5：通道發布**
- 同步發布至所有 Route 1 通道
- 確保所有通道內容一致

---

## 通道映射與轉換規格

### 1. Cell Broadcast（細胞廣播）

**轉換規格**：
- **標題**：CAP Info.headline（限制 90 字元）
- **內容**：CAP Info.description + Info.instruction（限制 1390 字元）
- **區域**：CAP Area.zone_id（轉換為細胞識別碼列表）
- **過期時間**：CAP Expires（轉換為 UTC 時間戳）

**技術規格**：
- 標準：3GPP TS 23.041（Cell Broadcast Service）
- 編碼：UTF-8
- 優先級：Emergency（最高優先級）

**限制**：
- 標題長度：90 字元
- 內容長度：1390 字元
- 區域範圍：基於細胞識別碼（需電信業者支援）

---

### 2. Location-based SMS（位置型簡訊）

**轉換規格**：
- **標題**：CAP Info.headline（限制 70 字元）
- **內容**：CAP Info.description + Info.instruction（限制 160 字元，可分段）
- **區域**：CAP Area.zone_id（轉換為位置區域碼）
- **過期時間**：CAP Expires（轉換為 UTC 時間戳）

**技術規格**：
- 標準：3GPP TS 23.040（SMS）
- 編碼：UTF-8（或 GSM 7-bit，依電信業者支援）
- 優先級：High（高優先級）

**限制**：
- 標題長度：70 字元
- 內容長度：160 字元（單則），可分段發送
- 區域範圍：基於位置區域碼（需電信業者支援）

---

### 3. Public Signage & PA Templates（公共看板與廣播模板）

**轉換規格**：
- **標題**：CAP Info.headline（顯示於電子看板）
- **內容**：CAP Info.description + Info.instruction（顯示於電子看板）
- **廣播腳本**：基於 CAP Info 生成語音廣播腳本（限制 60 秒）
- **區域**：CAP Area.zone_id（用於選擇顯示/廣播區域）
- **過期時間**：CAP Expires（用於自動關閉顯示/廣播）

**技術規格**：
- **電子看板**：HTML/CSS 格式（可轉換為其他格式）
- **語音廣播**：文字轉語音（TTS）或預錄音檔
- **編碼**：UTF-8

**限制**：
- 標題長度：依看板規格（建議 < 50 字元）
- 內容長度：依看板規格（建議 < 200 字元）
- 廣播長度：60 秒（可分段）

---

### 4. Web/Social/Radio/TV Replication（網路/社群/廣播/電視複製）

**轉換規格**：
- **完整 CAP 訊息**：以 XML 或 JSON 格式發布
- **網頁顯示**：基於 CAP Info 生成 HTML 頁面
- **社群媒體**：基於 CAP Info.headline + Info.description 生成貼文（限制依平台）
- **廣播/電視**：基於 CAP Info 生成廣播腳本（限制 30-60 秒）

**技術規格**：
- **CAP XML**：符合 OASIS CAP 1.2 標準
- **CAP JSON**：符合 OASIS CAP 1.2 JSON 格式
- **編碼**：UTF-8

**限制**：
- 依各平台規格（例如：Twitter 280 字元、Facebook 5000 字元）

---

## 通道優先順序與降級策略

### 通道優先順序

**優先級 1（最高）**：
- Cell Broadcast（最廣泛覆蓋）
- Location-based SMS（備用，當 Cell Broadcast 不可用時）

**優先級 2（高）**：
- Public Signage & PA（站內/車內直接指引）

**優先級 3（中）**：
- Web/Social/Radio/TV（補充通道，非主要）

### 降級策略

**策略 1：通道故障降級**
- 當優先級 1 通道故障時，自動切換至優先級 2 通道
- 當優先級 2 通道故障時，自動切換至優先級 3 通道
- 所有降級動作記錄於審計日誌

**策略 2：部分故障處理**
- 當部分通道故障時，繼續使用可用通道
- 不影響其他通道的正常運作

**策略 3：完全故障處理**
- 當所有通道故障時，標記為「系統故障」
- 通知維護人員
- 記錄故障時間與原因

---

## 多語言支援機制

### 支援語言

**預設語言**：
- 繁體中文（主要）
- 英文（次要）

**擴充語言**（依政策需求）：
- 簡體中文
- 日文
- 韓文
- 其他（依區域需求）

### 多語言 CAP 訊息

**CAP Info 區塊**：
- 每個語言建立獨立的 Info 區塊
- 所有語言的 Info 區塊包含相同的核心資訊（事件、緊急度、嚴重度、確定度）
- 僅語言特定欄位（headline、description、instruction）進行翻譯

**翻譯流程**：
1. 生成主要語言（繁體中文）的 CAP 訊息
2. 翻譯語言特定欄位至其他語言
3. 驗證翻譯準確性（自動檢查 + 人工審核）
4. 將所有語言的 Info 區塊加入 CAP 訊息

### 通道語言選擇

**Cell Broadcast / SMS**：
- 依裝置語言設定選擇對應語言的 Info 區塊
- 若裝置語言不支援，使用預設語言（繁體中文）

**Public Signage & PA**：
- 同時顯示/播放所有支援語言
- 或依區域需求選擇特定語言

**Web/Social/Radio/TV**：
- 依平台語言設定選擇對應語言的 Info 區塊
- 或提供多語言版本連結

---

## 通道可用性監控與故障處理

### 可用性監控

**監控指標**：
- 通道狀態（正常/故障/降級）
- 訊息發布成功率（> 95%）
- 訊息延遲（< 5 秒，95% 分位數）

**監控方法**：
- 每 30 秒檢查通道狀態
- 記錄訊息發布成功/失敗事件
- 記錄訊息延遲時間

**故障檢測**：
- 通道無回應（超過 60 秒）
- 訊息發布失敗（連續 3 次）
- 訊息延遲過高（> 30 秒）

### 故障處理流程

**步驟 1：故障檢測**
- 系統自動檢測通道故障
- 標記通道為「故障」狀態

**步驟 2：降級切換**
- 自動切換至備用通道（依優先順序）
- 記錄降級動作於審計日誌

**步驟 3：故障通知**
- 通知維護人員
- 記錄故障時間、原因與影響範圍

**步驟 4：故障恢復**
- 當通道恢復正常時，自動切換回原通道
- 記錄恢復時間於審計日誌

---

## CAP 訊息驗證與一致性檢查

### 驗證流程

**步驟 1：格式驗證**
- 檢查 CAP 訊息格式是否符合 OASIS CAP 1.2 標準
- 檢查必填欄位是否完整

**步驟 2：內容驗證**
- 檢查 CAP 訊息內容是否合理（例如：時間戳、區域識別碼）
- 檢查 CAP 訊息內容是否與當前區域狀態一致

**步驟 3：數位簽章驗證**
- 驗證 CAP 訊息的數位簽章
- 確保訊息完整性與來源驗證

**步驟 4：一致性檢查**
- 檢查所有通道的 CAP 訊息內容是否一致
- 確保所有通道使用相同的 CAP 訊息識別碼

### 一致性檢查機制

**檢查項目**：
- CAP 訊息識別碼（所有通道需相同）
- CAP 訊息內容（所有通道需一致）
- CAP 訊息時間戳（所有通道需同步）

**檢查方法**：
- 在發布前比較所有通道的 CAP 訊息內容
- 在發布後驗證所有通道的實際發布內容

**不一致處理**：
- 檢測到不一致時，自動停止發布
- 通知操作人員
- 重新生成 CAP 訊息並驗證

---

## 與 Route 2 的同步機制

### 同步原則

1. **CAP 訊息一致性**
   - Route 1 與 Route 2 使用相同的 CAP 訊息
   - 確保所有通道內容一致

2. **發布時間同步**
   - Route 1 與 Route 2 同時發布（時間差 < 5 秒）
   - 確保使用者收到一致的指引

3. **狀態同步**
   - Route 1 與 Route 2 共享相同的區域狀態
   - 確保狀態一致性

### 同步機制

**機制 1：CAP 訊息共享**
- Route 1 與 Route 2 使用相同的 CAP 訊息生成流程
- 確保內容一致性

**機制 2：發布協調**
- Route 1 與 Route 2 的發布動作需協調
- 使用分散式鎖確保同時發布

**機制 3：狀態共享**
- Route 1 與 Route 2 共享區域狀態資料庫
- 確保狀態一致性

### 同步失敗處理

**處理方式**：
- 當同步失敗時，Route 1 優先（最低保證）
- Route 2 降級至僅顯示 Route 1 內容
- 記錄同步失敗事件於審計日誌

---

## 假設

- 所有通道正常運作（可用性 > 99%）
- 電信業者支援 Cell Broadcast 與 Location-based SMS
- 多語言翻譯準確（需人工審核）

## 攻擊考量

- CAP 訊息偽造：需數位簽章與完整性驗證
- 通道入侵：需通道間隔離與安全通訊
- 一致性檢查繞過：需自動驗證機制與操作日誌審計

## 隱私影響

- CAP 訊息為公開資訊，不涉及個別資料
- 通道發布記錄需審計日誌

